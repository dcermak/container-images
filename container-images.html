<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Container und Container Images</title>
<meta name="author" content="Dan ÄŒermÃ¡k"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./node_modules/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./node_modules/reveal.js/dist/theme/simple.css" id="theme"/>

<link rel="stylesheet" href="./node_modules/@fortawesome/fontawesome-free/css/all.min.css"/>

<link rel="stylesheet" href="./custom-style.css"/>
<link rel="stylesheet" href="./node_modules/reveal.js/plugin/highlight/zenburn.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './node_modules/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h2 class="title">Container und Container Images</h2>
<p class="subtitle" style="color: Gray;">Was verbirgt sich dahinter?</p>
<p class="author">Dan ÄŒermÃ¡k</p>
<div style="float:left"><a href="https://chemnitzer.linux-tage.de/2025/" target="_blank"><img src="./media/clt-logo_2025_en.svg" height="50px"/></a></div>
<div style="float:right;font-size:35px;"><p xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#"><a href="https://creativecommons.org/licenses/by/4.0" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
CC BY 4.0 <i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i></a></p></div>
</section>

<section>
<section id="slide-org6e3b895">
<h2 id="org6e3b895"><code>who -u</code></h2>
<p>
Dan ÄŒermÃ¡k
</p>

<p>
 <div style="float:center">
 <table class="who-table">
 <tr><td><i class="fab fa-suse"></i></td><td> Software Developer @SUSE</td></tr>
 <tr><td><i class="fab fa-fedora"></i></td><td> i3 SIG, Package maintainer</td></tr>
 <tr><td><i class="far fa-heart"></i></td><td> Developer Tools, Testing and Documentation, Home Automation</td></tr>
 <tr></tr>
 <tr></tr>
 <tr><td><i class="fa-solid fa-globe"></i></td><td> <a href="https://dancermak.name/">https://dancermak.name</a></td></tr>
 <tr><td><i class="fab fa-github"></i></td><td> <a href="https://github.com/dcermak/">dcermak</a> </td></tr>
 <tr><td><i class="fab fa-mastodon"></i></td><td> <a href="https://mastodon.social/@Defolos">@Defolos@mastodon.social</a></td></tr>
 </table>
 </div>
</p>


</section>
</section>
<section>
<section id="slide-orge2cb54e">
<h2 id="orge2cb54e"><span class="todo TODO">TODO</span> Agenda</h2>


</section>
</section>
<section>
<section id="slide-orgefdaba5">
<h2 id="orgefdaba5">Software Delivery</h2>
<aside class="notes">
<ul>
<li>dependencies suck, dependency handling sucks, don't wanna handle 20 different library versions</li>
<li></li>

</ul>

</aside>

<ul>
<li class="fragment appear">dependencies suck &rarr; bundle everything</li>
<li class="fragment appear">Can't we just ship everything?</li>
<li class="fragment appear">yes, but VMs suck as well ðŸ« </li>

</ul>


</section>
<section id="slide-orgcd7c868">
<h3 id="orgcd7c868">Let's build a container</h3>
<aside class="notes">
<ul>
<li>build everything locally or in a pre-installed VM</li>
<li>tar the whole thing</li>
<li>clean up everything (logs, temporary build deps, etc)</li>

</ul>

</aside>

<ol>
<li class="fragment appear">Create a chroot: <code>rsync -avz --exclude=/sysroot/ / /sysroot/</code></li>
<li class="fragment appear">build your app</li>
<li class="fragment appear"><code>tar -czvf my-app.tar.gz /sysroot</code></li>
<li class="fragment appear">clean the archive of everything unneeded</li>

</ol>


</section>
<section id="slide-org54556fb">
<h3 id="org54556fb">Let's run the container</h3>
<ol>
<li class="fragment appear"><code>tar -xzvf my-app.tar.gz -C /path/to/app</code></li>
<li class="fragment appear"><code>chroot /path/to/app /usr/local/bin/my-app</code></li>

</ol>


</section>
<section id="slide-org424ff5d">
<h3 id="org424ff5d">Is that it?</h3>
<ul>
<li class="fragment appear">inconvenient build process</li>
<li class="fragment appear">no upgrade path</li>
<li class="fragment appear">data sharing?</li>
<li class="fragment appear">no security</li>

</ul>


</section>
<section id="slide-orgbec3c4d">
<h3 id="orgbec3c4d">Linux Namespaces</h3>
<aside class="notes">
<ul>
<li>introduced in 2002 (kernel 2.4), more added in 2006</li>
<li>container support finished in 2013: user namespace with kernel 3.8</li>
<li>user: separate user ids of namespace &amp; host, map uids between host &amp; namespace
&rArr; uid 0 in namespace is user who created namespace
(&rarr; see also <code>/etc/subuid</code>)</li>
<li>mnt: mount namespace, isolated mounts</li>
<li>pid: Process ID isolation, process that "created" the namespace gets PID 1 and
all other processes become its children (also of sub-namespaces)</li>
<li>net: each net inerface in one namespace</li>
<li>ipc: restrict SysV style IPC</li>
<li>uts - unix time sharing: set hostname &amp; domainname</li>
<li>cgroup (added in 4.6): hide cgroup path, i.e. process only sees relative
cgroup path of the namespace and no others</li>
<li>time (added in 5.6): set different system time</li>

<li>useful tool: lsns</li>

</ul>

</aside>

<ul>
<li class="fragment appear">kernel level resource isolation</li>

</ul>

<p class="fragment (appear)">
available namespaces:
</p>

<ul>
<li class="fragment appear">user</li>
<li class="fragment appear">mnt</li>
<li class="fragment appear">pid</li>
<li class="fragment appear">net</li>
<li class="fragment appear">ipc</li>
<li class="fragment appear">uts</li>
<li class="fragment appear">cgroup</li>
<li class="fragment appear">time</li>

</ul>

</section>
<section id="slide-orgbec3c4d-split">

<p>
Try it:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="shell" data-line-numbers='1-3|4-5|6-9'>$ unshare --user --map-root-user \
      --pid --fork --mount-proc \
      /bin/bash
# whoami
root
# ps -a
    PID TTY          TIME CMD
      1 pts/8    00:00:00 bash
    104 pts/8    00:00:00 ps
</code></pre>
</div>


</section>
<section id="slide-org27ad391">
<h3 id="org27ad391">cgroups</h3>
<aside class="notes">
<ul>
<li>started in 2006, merged in 2008 (2.6.24)</li>
<li>redesigned to v2 in 2016 (4.5)</li>

<li>resource limits like I/O, FS caches, CPU quota, open files</li>
<li>process priorization</li>
<li>measure whole group resource usage &amp; freeze/restart it</li>

<li>nowadays used by userspace memory killers</li>
<li>modern DEs put each process into a cgroup &rarr; for oom-killers</li>

</ul>

</aside>

<ul>
<li class="fragment appear">apply resource limits to processes</li>
<li class="fragment appear">measure resource usage</li>

</ul>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="shell" data-line-numbers='1|2|3-4'># cgcreate -g memory:memlimit
# cgset -r memory.max=1K memlimit
# cgexec -g memory:memlimit ls -al
Killed
</code></pre>
</div>


</section>
<section id="slide-org85c0fa9">
<h3 id="org85c0fa9">Are we there yet?</h3>
<p class="fragment (appear)">
What do we have?
</p>
<p class="fragment (appear)">
great process isolation
</p>

<p class="fragment (appear)">
What's lacking?
</p>
<ul>
<li class="fragment appear">standardized build process</li>
<li class="fragment appear">distribution mechanism</li>

</ul>


</section>
</section>
<section>
<section id="slide-orgb044ade">
<h2 id="orgb044ade">Introducing: Docker</h2>
<aside class="notes">
<ul>
<li>solve the redistribution &amp; build process</li>

</ul>

</aside>

<p class="fragment (appear)">
<img src="./media/Docker_(container_engine)_logo.svg"/>
</p>

<ol>
<li class="fragment appear">Docker registry</li>
<li class="fragment appear"><code>docker build</code></li>

</ol>


</section>
<section id="slide-org37f6c99">
<h3 id="org37f6c99">Docker Registry</h3>
<p class="fragment (appear)">
<img src="./media/registry.svg"/>
</p>

<aside class="notes">
<ul>
<li>central image storage, initially there was only <a href="https://hub.docker.com">Docker Hub</a> (nowadays many registries exist)</li>
<li>images identified via <code>repository:tag@digest</code></li>
<li>repository: name of the image</li>
<li>tag: something like a version, but really a free form field
only special value is <code>:latest</code>, pulled by default
you can have multiple images with the same tag ðŸ˜’</li>
<li>digest: sha256 or sha512 hash of the image manifest</li>

</ul>

<p>
Digests:
some background: OCI registries return to <code>GET
/v2/&lt;repo&gt;/manifests/&lt;tag&gt;</code> either a <code>distribution.manifest</code> or a
<code>distribution.manifest.list</code> (that's a list of <code>distribution.manifest</code>), the digest
of an image is the sha256sum/sha512sum of the <code>distribution.manifest</code>
</p>

</aside>


</section>
<section id="slide-org7a97945">
<h3 id="org7a97945">Container Image Build</h3>
<aside class="notes">
<ul>
<li>fix the inconvenient build process</li>
<li>docker build standardized &amp; simplified the image build process via the
<code>Dockerfile</code></li>
<li>syntax is: <code>INSTRUCTION &lt;value&gt;</code></li>
<li>image build starts <code>FROM</code> an image specified using the same format as the
registry</li>
<li>each instruction creates a layer, changes put on top, build process relies
heavily on caching</li>

</ul>

</aside>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="bash" >docker build .
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="Dockerfile" data-line-numbers='1|3|5|6|7'>FROM registry.opensuse.org/opensuse/tumbleweed

RUN zypper -n in emacs

ENV EMACS_VERSION=30.1
USER emacs
CMD ["/usr/bin/emacs", "-q"]
</code></pre>
</div>

</section>
<section id="slide-orga15bf1d">
<h3 id="orga15bf1d">UnionFS</h3>
<aside class="notes">
<ul>
<li>final image constructed from individual layers</li>
<li>file precedence: "highest directory" over "lowest"</li>
<li>file removal: via whiteout files,
in overlayFS: character special file (device 0, 0), create via <code>mknod $path c 0 0</code>
oci tar archives prepend <code>.wh.</code>, empty file</li>
<li>directory removal: whiteout file
oci tar archives: <code>dir/.wh..wh..opq</code> empty file
in overlayFS: character special file in upper dir (again created via <code>mknod</code>)</li>

</ul>

<p>
catches:
</p>
<ul>
<li>you can never truly delete files</li>
<li>editing a file creates a full copy (unionFS works on a file level)</li>
<li>certain operations not atomic</li>
<li>directory renames are very ugly (delete + full copy)</li>

<li>try it locally with OverlayFS on Linux,
lowerdir: read only layers
upperdir: rw top dir (= container dir)
workdir: used for internal purposes (CoW)</li>

</ul>

</aside>

<p class="fragment (appear)">
<img src="./media/overlays.svg"/>
</p>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="bash" >mount -t overlay overlay \
      -o lowerdir=Layer 3:Layer 2:Layer 1,\
         upperdir=Container,workdir=/work/ \
           merged
</code></pre>
</div>


</section>
<section id="slide-org582b908">
<h3 id="org582b908">Dockerfile</h3>
<aside class="notes">
<ul>
<li><code>FROM</code> - specifies the base image for the current build stage</li>
<li><code>ARG</code> - set build arguments, can be passed via <code>--build-arg "USER=me"</code> CLI flag</li>
<li><code>COPY</code> - copy files from the current build context (the directory passed as last
CLI arg) or from other stage to current stage
<code>ADD</code> used to fill this use case, but discouraged nowadays</li>
<li><code>ENV</code>: set environment variables, global for rest of build stage &amp; final image</li>
<li><code>RUN</code>: execute arbitrary commands in the container image context, using the
default shell. Beware of shell escapes when creating multiline strings, often
resort to hacks like <a href="https://stackoverflow.com/a/33439625">ksh93 ANSI-C quoting</a>
supports also flags like mounting secrets or setting the network</li>
<li><code>LABEL</code>: add key-value metadata to the image, common ones:
<a href="https://github.com/opencontainers/image-spec/blob/main/annotations.md">https://github.com/opencontainers/image-spec/blob/main/annotations.md</a></li>
<li><code>VOLUME</code>: declares a directory as a volume, everything in it is temporary from
this layer on, when launching the container a temporary volume is created</li>
<li><code>WORKDIR</code>: sets the cwd for all subsequent instructions &amp; for entrypoint/cmd</li>
<li><code>EXPOSE</code>: defines network ports to be exposed, but only documentation. protocol
can be specified, defaults to TCP if not supplied. Ports still have to be
exposed via <code>-p $hostPort:$ctrPort</code> or all via <code>-P</code></li>
<li><code>USER</code>: defines the user for entrypoint &amp; cmd and subsequent <code>RUN</code> instructions,
must exist in the image!</li>
<li><code>CMD</code>: default args for the entrypoint</li>
<li><code>ENTRYPOINT</code>: defines binary launched as PID 1</li>

</ul>

<p>
additional directives:
</p>
<ul>
<li><code>SHELL</code>: sets the shell, defaults to <code>["/bin/sh", "-c"]</code></li>
<li><code>STOPSIGNAL</code>: which signal should be sent to PID 1 on <code>docker stop</code> (defaults to
<code>SIGTERM</code>)</li>

</ul>

<p>
non-standard:
</p>
<ul>
<li><code>HEALTHCHECK</code>: command to check whether application in container is up</li>
<li><code>ONBUILD</code>: commands executed when using this image for building</li>

</ul>

</aside>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="Dockerfile" data-line-numbers='1|2|3|4|5-8|9|10|11|12|13|14|15-16'>FROM registry.opensuse.org/opensuse/tumbleweed
ARG USER="geeko"
COPY ./project/ /src/
ENV USER="${USER}"
RUN zypper -n in openssh-clients; \
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N ""; \
    zypper -n rm --clean-deps openssh-clients; \
    zypper -n clean; rm -rf /var/log/lastlog;
LABEL org.opencontainers.image.authors="Me"
VOLUME ["/src/data"]
WORKDIR /src/
EXPOSE 22
RUN useradd $USER
USER $USER
CMD ["echo hello"]
ENTRYPOINT ["/bin/bash", "-ce"]
</code></pre>
</div>


</section>
<section id="slide-orgd4c4420">
<h3 id="orgd4c4420">Volumes</h3>
<aside class="notes">
<ul>
<li>data of a container exist in the (somewhat) temporary <code>upper</code> dir
&rArr; app data not persisted, must be mounted from external</li>
<li>bind mount</li>
<li>container volume (mount data provided by container engine, implementation
defined, but usually folder)</li>

<li>beware of SELinux! &rArr; (podman) launches container process with <code>container_t</code>
label, can only access files with <code>container_file_t</code> label (not present <b>anywhere</b>
by default) &rArr; <code>:Z</code> &amp; <code>:z</code> flags relabel volumes and add this flag,
see: <a href="https://www.redhat.com/en/blog/user-namespaces-selinux-rootless-containers">https://www.redhat.com/en/blog/user-namespaces-selinux-rootless-containers</a></li>

</ul>

</aside>

<p class="fragment (appear)">
<img src="./media/volumes.svg"/>
</p>

<pre  class="fragment (appear)" >
docker run -v /vol/:/var/db/ -v logs:/var/log $img
</pre>

</section>
<section id="slide-orga6a6419">
<h3 id="orga6a6419">Entrypoint</h3>
<aside class="notes">
<ul>
<li>entrypoint is launched as PID 1 in pid namespace by OCI runtime
&rArr; everything in PID namespace becomes child process
&rArr; must forward signals to children &amp; reap them</li>
<li>entrypoint should <b>not</b> be a shell &rArr; use the exec form and not the free form to
define the <code>ENTRYPOINT</code>, i.e.: <code>ENTRYPOINT ["//bin/foo//", "arg"]</code></li>
<li>entrypoint gets passed <code>CMD</code> as args by default</li>
<li>entrypoint should handle custom args, e.g. to launch a shell then</li>
<li>exec the actual container process, not just launch it as a subprocess (messes
up signal handling)</li>
<li>sign that signal handling is messed up:
<code>WARN[0010] StopSignal SIGTERM failed to stop container $FOO in 10 seconds, resorting to SIGKILL</code></li>

<li>preferably don't run a full init like systemd (hardly doable with docker)</li>
<li>general scheme: support configuration via environment variables</li>

</ul>

</aside>

<p class="fragment (appear)">
<img src="./media/entrypoint.svg"/>
</p>


</section>
<section id="slide-org524b626">
<h3 id="org524b626">Networking</h3>
<aside class="notes">
<ul>
<li>containers can reach outside, but not other way around</li>
<li>ports need to be explicitly exposed</li>

</ul>

</aside>

<p class="fragment (appear)">
<img src="./media/entrypoint.svg"/>
</p>


</section>
<section id="slide-orgfaec967">
<h3 id="orgfaec967">Containers are not VMs</h3>
<ul>
<li class="fragment appear"></li>

</ul>

</section>
<section id="slide-org94de698">
<h3 id="org94de698">Launching a Container</h3>
<ol>
<li class="fragment appear">Lookup image locally</li>
<li class="fragment appear">(optionally) pull the image</li>
<li class="fragment appear">write layers to disk &amp; setup unionfs</li>
<li class="fragment appear">setup namespaces &amp; cgroups</li>
<li class="fragment appear">setup networking</li>
<li class="fragment appear">launch entrypoint using <code>runc</code> / <code>crun</code> / <code>$runtime</code></li>

</ol>


</section>
<section id="slide-org3406ce4">
<h3 id="org3406ce4">Best practices</h3>
<ul>
<li>one entrypoint &rArr; one binary</li>
<li>configure via env vars</li>
<li>volumes for persistent data</li>
<li>don't run a full init</li>

</ul>


</section>
<section id="slide-org0e812d9">
<h3 id="org0e812d9">Podman</h3>

</section>
<section id="slide-orgd0cb46e">
<h3 id="orgd0cb46e">Container Orchestration</h3>


</section>
</section>
<section>
<section id="slide-orgbeea48b">
<h2 id="orgbeea48b">Kubernetes</h2>

</section>
</section>
<section>
<section id="slide-orge9b5952">
<h2 id="orge9b5952">Questions?</h2>
<p class="fragment (appear)">
Answers!
</p>
</section>
</section>
</div>
</div>
<script src="./node_modules/reveal.js/dist/reveal.js"></script>
<script src="./node_modules/reveal.js/plugin/highlight/highlight.js"></script>
<script src="./node_modules/reveal.js/plugin/notes/notes.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealHighlight, RevealNotes, history],
transition: 'none', hash: true
});

</script>
</body>
</html>
